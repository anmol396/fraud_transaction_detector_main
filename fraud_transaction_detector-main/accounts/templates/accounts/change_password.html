{% extends 'accounts/auth_base.html' %}
{% load static %}

{% block title %}Change Password - BFSI Transaction Monitoring{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/auth-modern.css' %}">
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-card-body">
            <div class="auth-icon-header">
                <div class="auth-icon-wrapper">
                    <i class="bi bi-key"></i>
                </div>
                <h2 class="auth-title">Change Password</h2>
                <p>Update your account password</p>
            </div>

            <form method="post" id="changePasswordForm">
                {% csrf_token %}

                <!-- Current Password -->
                <div class="auth-field">
                    <label for="{{ form.old_password.id_for_label }}" class="auth-label">
                        <i class="bi bi-lock-fill me-2"></i>Current Password
                    </label>
                    <div class="auth-password-container">
                        <input type="password" class="auth-password-input" name="{{ form.old_password.name }}" id="{{ form.old_password.id_for_label }}" placeholder="Enter current password" required>
                        <button type="button" class="auth-password-toggle" onclick="togglePassword('{{ form.old_password.id_for_label }}', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    {% if form.old_password.errors %}
                    <div class="auth-error">{{ form.old_password.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- New Password -->
                <div class="auth-field">
                    <label for="{{ form.new_password1.id_for_label }}" class="auth-label">New Password</label>
                    <div class="auth-password-container">
                        <input type="password" class="auth-password-input" name="{{ form.new_password1.name }}" id="{{ form.new_password1.id_for_label }}" placeholder="Enter new password" required>
                        <button type="button" class="auth-password-toggle" onclick="togglePassword('{{ form.new_password1.id_for_label }}', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>

                    <!-- Password Requirements -->
                    <div class="auth-pwd-req" id="passwordRequirements">
                        <div class="requirement" id="lengthReq">
                            <i class="bi bi-circle"></i>
                            At least 8 characters
                        </div>
                        <div class="requirement" id="numberReq">
                            <i class="bi bi-circle"></i>
                            Contains a number
                        </div>
                        <div class="requirement" id="specialReq">
                            <i class="bi bi-circle"></i>
                            Contains a special character
                        </div>
                    </div>

                    {% if form.new_password1.errors %}
                    <div class="auth-error">{{ form.new_password1.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Confirm New Password -->
                <div class="auth-field">
                    <label for="{{ form.new_password2.id_for_label }}" class="auth-label">Confirm Password</label>
                    <div class="auth-password-container">
                        <input type="password" class="auth-password-input" name="{{ form.new_password2.name }}" id="{{ form.new_password2.id_for_label }}" placeholder="Confirm new password" required>
                        <button type="button" class="auth-password-toggle" onclick="togglePassword('{{ form.new_password2.id_for_label }}', this)">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div id="passwordMatch"></div>
                    {% if form.new_password2.errors %}
                    <div class="auth-error">{{ form.new_password2.errors.0 }}</div>
                    {% endif %}
                </div>

                <button type="submit" class="auth-btn" id="changePasswordBtn">
                    <span id="changePasswordBtnText">
                        <i class="bi bi-check-circle-fill me-2"></i>Change Password
                    </span>
                    <span id="changePasswordBtnLoader" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                </button>
            </form>

            <div class="auth-footer">
                <a href="{% url 'profile' %}" class="auth-link">
                    <i class="bi bi-arrow-left me-2"></i>Back to Profile
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global password toggle function
    function togglePassword(inputId, button) {
        const passwordInput = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            passwordInput.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Password requirements functionality
        const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
        const confirmPasswordInput = document.getElementById('{{ form.new_password2.id_for_label }}');
        const passwordReq = document.getElementById('passwordRequirements');
        const lengthReq = document.getElementById('lengthReq');
        const numberReq = document.getElementById('numberReq');
        const specialReq = document.getElementById('specialReq');
        const matchDiv = document.getElementById('passwordMatch');

        if (passwordInput && passwordReq) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                
                // Show requirements when user starts typing
                if (password.length > 0) {
                    passwordReq.classList.add('show');
                } else {
                    passwordReq.classList.remove('show');
                }
                
                // Check length requirement
                if (password.length >= 8) {
                    lengthReq.classList.add('valid');
                    lengthReq.querySelector('i').className = 'bi bi-check-circle-fill';
                } else {
                    lengthReq.classList.remove('valid');
                    lengthReq.querySelector('i').className = 'bi bi-circle';
                }

                // Check number requirement
                if (/\d/.test(password)) {
                    numberReq.classList.add('valid');
                    numberReq.querySelector('i').className = 'bi bi-check-circle-fill';
                } else {
                    numberReq.classList.remove('valid');
                    numberReq.querySelector('i').className = 'bi bi-circle';
                }

                // Check special character requirement
                if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                    specialReq.classList.add('valid');
                    specialReq.querySelector('i').className = 'bi bi-check-circle-fill';
                } else {
                    specialReq.classList.remove('valid');
                    specialReq.querySelector('i').className = 'bi bi-circle';
                }
                
                // Check password match
                checkPasswordMatch();
            });
            
            // Hide requirements when field loses focus and is empty
            passwordInput.addEventListener('blur', function() {
                if (passwordInput.value === '') {
                    passwordReq.classList.remove('show');
                }
            });
        }

        function checkPasswordMatch() {
            if (confirmPasswordInput && matchDiv) {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (confirmPassword) {
                    if (password === confirmPassword) {
                        matchDiv.textContent = 'Passwords match';
                        matchDiv.className = 'text-success';
                    } else {
                        matchDiv.textContent = 'Passwords do not match';
                        matchDiv.className = 'text-danger';
                    }
                } else {
                    matchDiv.textContent = '';
                }
            }
        }

        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        }

        // Handle form submission
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            const btn = document.getElementById('changePasswordBtn');
            const btnText = document.getElementById('changePasswordBtnText');
            const btnLoader = document.getElementById('changePasswordBtnLoader');

            btn.disabled = true;
            btnText.textContent = 'Changing...';
            btnLoader.classList.remove('d-none');
        });
    });
</script>
{% endblock %}
